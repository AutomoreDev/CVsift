rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is a master account
    function isMaster() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'master';
    }

    // Helper function to check if user is a team member of the specified owner
    function isTeamMemberOfUser(ownerId) {
      // Since teamMembers uses auto-generated IDs, we allow the update if:
      // 1. User is updating their own document, OR
      // 2. User is updating ONLY cvUploadsThisMonth or cvPackBalance fields (counter increments from team members)
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(['cvUploadsThisMonth', 'cvPackBalance']);
    }

    // Users collection
    match /users/{userId} {
      // Users can access their own data
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // Master account can read all users
      allow read: if isMaster();
      // Master account can update any user (except changing role to master)
      allow update: if isMaster() &&
                       (!request.resource.data.keys().hasAny(['role']) ||
                        request.resource.data.role != 'master' ||
                        request.auth.uid == userId);
      // Team members can update ONLY CV counter fields for their team owner
      allow update: if request.auth != null &&
                       request.auth.uid != userId &&
                       isTeamMemberOfUser(userId);
    }

    // CVs collection - users can access their own CVs via direct queries
    // Team members access owner's CVs through Cloud Functions (getTeamCVs) which use Admin SDK
    match /cvs/{cvId} {
      // For reads, check the existing document's userId or if user is master
      allow read: if request.auth != null &&
                     (resource.data.userId == request.auth.uid || isMaster());
      // For create: allow if creating for own userId OR if uploadedBy matches auth user (team member uploading for owner)
      allow create: if request.auth != null &&
                       (request.resource.data.userId == request.auth.uid ||
                        request.resource.data.uploadedBy == request.auth.uid ||
                        isMaster());
      allow update, delete: if request.auth != null &&
                               (resource.data.userId == request.auth.uid || isMaster());
    }

    // Job specifications collection
    // Team members access owner's job specs through their own queries (teamOwnerId stored in user context)
    match /jobSpecs/{jobSpecId} {
      allow read: if request.auth != null &&
                     (resource.data.userId == request.auth.uid || isMaster());
      // Allow create if creating for own userId OR if createdBy matches auth user (team member creating for owner)
      allow create: if request.auth != null &&
                       (request.resource.data.userId == request.auth.uid ||
                        request.resource.data.createdBy == request.auth.uid ||
                        isMaster());
      // Allow update/delete only for owner or master
      allow update, delete: if request.auth != null &&
                               (resource.data.userId == request.auth.uid || isMaster());
    }

    // Custom field configurations - users can only access their own config
    match /customFieldConfigs/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // Master account can read all configs
      allow read: if isMaster();
    }

    // Payments collection - users can only access their own payments
    match /payments/{paymentId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // Team Members collection
    match /teamMembers/{memberId} {
      // Team owner can read/write their team members
      allow read, write: if request.auth != null && resource.data.teamOwnerId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.teamOwnerId == request.auth.uid;
      // Team members can read their own membership
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Team Invites collection
    match /teamInvites/{inviteId} {
      // User who sent invite can read/write
      allow read, write: if request.auth != null && resource.data.invitedBy == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.invitedBy == request.auth.uid;
      // Invited user can read their own invite
      allow read: if request.auth != null &&
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.email == resource.data.email;
      // Invited user can update status when accepting
      allow update: if request.auth != null &&
                       exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.email == resource.data.email &&
                       request.resource.data.status == 'accepted';
    }

    // Activity Logs collection
    match /activityLogs/{logId} {
      // Team owner can read their team's activity logs
      allow read: if request.auth != null && resource.data.teamOwnerId == request.auth.uid;
      // Master account can read all logs
      allow read: if isMaster();
      // Only cloud functions can create logs (no direct client writes)
      allow create: if false;
      allow update, delete: if false;
    }

    // Chatbot Usage collection - backend only
    match /chatbotUsage/{usageId} {
      // Only Cloud Functions can read/write (for billing/analytics)
      allow read, write: if false;
    }

    // API Calls collection - backend only
    match /apiCalls/{callId} {
      // Only Cloud Functions can read/write (for billing/monitoring)
      allow read, write: if false;
    }

    // Rate Limits collection - backend only
    match /rateLimits/{limitId} {
      // Only Cloud Functions can read/write
      allow read, write: if false;
    }

    // Master Audit Logs collection - master accounts only
    match /masterAuditLogs/{auditId} {
      // Only master accounts can read audit logs
      allow read: if isMaster();
      // Only Cloud Functions can create logs
      allow create, update, delete: if false;
    }

    // EEA Companies collection
    match /companies/{companyId} {
      // Users can read their own company
      allow read: if request.auth != null &&
                     resource.data.ownerId == request.auth.uid;
      // Users can create a company for themselves
      allow create: if request.auth != null &&
                       request.resource.data.ownerId == request.auth.uid;
      // Users can update their own company
      allow update: if request.auth != null &&
                       resource.data.ownerId == request.auth.uid;
      // Users can delete their own company
      allow delete: if request.auth != null &&
                       resource.data.ownerId == request.auth.uid;
      // Master accounts can read/write all companies
      allow read, write: if isMaster();
    }

    // EEA Employees collection
    match /employees/{employeeId} {
      // Helper function to check if user owns the company
      function ownsCompany() {
        let companyId = resource.data.companyId;
        return exists(/databases/$(database)/documents/companies/$(companyId)) &&
               get(/databases/$(database)/documents/companies/$(companyId)).data.ownerId == request.auth.uid;
      }

      function ownsCompanyForCreate() {
        let companyId = request.resource.data.companyId;
        return exists(/databases/$(database)/documents/companies/$(companyId)) &&
               get(/databases/$(database)/documents/companies/$(companyId)).data.ownerId == request.auth.uid;
      }

      // Users can read employees of their own company
      allow read: if request.auth != null && ownsCompany();
      // Users can create employees for their own company
      allow create: if request.auth != null && ownsCompanyForCreate();
      // Users can update employees of their own company
      allow update: if request.auth != null && ownsCompany();
      // Users can delete employees of their own company
      allow delete: if request.auth != null && ownsCompany();
      // Master accounts can read/write all employees
      allow read, write: if isMaster();
    }

    // EEA Sector Targets collection - read-only reference data
    match /sectorTargets/{targetId} {
      // Anyone authenticated can read sector targets
      allow read: if request.auth != null;
      // Only master can write (for seeding data)
      allow write: if isMaster();
    }

    // EEA EAP Targets collection - read-only reference data
    match /eapTargets/{targetId} {
      // Anyone authenticated can read EAP targets
      allow read: if request.auth != null;
      // Only master can write (for seeding data)
      allow write: if isMaster();
    }

    // Catch-all: Deny access to any other collections not explicitly defined
    match /{document=**} {
      allow read, write: if false;
    }
  }
}