/**
 * Firestore Security Rules for EEA Compliance Feature
 *
 * INSTRUCTIONS:
 * Add these rules to your existing firestore.rules file in the Firebase Console
 * or in your local firestore.rules file before deploying.
 *
 * These rules should be added inside the "match /databases/{database}/documents" block
 */

// ============================================
// EEA COMPLIANCE COLLECTIONS SECURITY RULES
// ============================================

// Companies Collection
// Users can only access their own company data
match /companies/{companyId} {
  // Allow read if user owns the company
  allow read: if request.auth != null &&
    (resource.data.ownerId == request.auth.uid);

  // Allow write if user owns the company (for creating/updating)
  allow write: if request.auth != null &&
    (request.resource.data.ownerId == request.auth.uid ||
     resource.data.ownerId == request.auth.uid);
}

// Employees Collection
// Users can only access employees for companies they own
match /employees/{employeeId} {
  // Helper function to check company ownership
  function ownsCompany() {
    let companyId = resource.data.companyId;
    return exists(/databases/$(database)/documents/companies/$(companyId)) &&
           get(/databases/$(database)/documents/companies/$(companyId)).data.ownerId == request.auth.uid;
  }

  function ownsCompanyCreate() {
    let companyId = request.resource.data.companyId;
    return exists(/databases/$(database)/documents/companies/$(companyId)) &&
           get(/databases/$(database)/documents/companies/$(companyId)).data.ownerId == request.auth.uid;
  }

  // Allow read if user owns the company
  allow read: if request.auth != null && ownsCompany();

  // Allow create if user owns the company
  allow create: if request.auth != null && ownsCompanyCreate();

  // Allow update/delete if user owns the company
  allow update, delete: if request.auth != null && ownsCompany();
}

// Compliance Snapshots Collection
// Historical compliance data - same access rules as employees
match /complianceSnapshots/{snapshotId} {
  function ownsCompany() {
    let companyId = resource.data.companyId;
    return exists(/databases/$(database)/documents/companies/$(companyId)) &&
           get(/databases/$(database)/documents/companies/$(companyId)).data.ownerId == request.auth.uid;
  }

  function ownsCompanyCreate() {
    let companyId = request.resource.data.companyId;
    return exists(/databases/$(database)/documents/companies/$(companyId)) &&
           get(/databases/$(database)/documents/companies/$(companyId)).data.ownerId == request.auth.uid;
  }

  allow read: if request.auth != null && ownsCompany();
  allow create: if request.auth != null && ownsCompanyCreate();
  allow update, delete: if request.auth != null && ownsCompany();
}

// Sector Targets Collection (Reference Data)
// Read-only for authenticated users
// Write access only through Firebase Console (admin only)
match /sectorTargets/{targetId} {
  allow read: if request.auth != null;
  allow write: if false; // Only admins via Firebase Console
}

// EAP Targets Collection (Reference Data)
// Read-only for authenticated users
// Write access only through Firebase Console (admin only)
match /eapTargets/{targetId} {
  allow read: if request.auth != null;
  allow write: if false; // Only admins via Firebase Console
}

/**
 * DEPLOYMENT INSTRUCTIONS:
 *
 * 1. Go to Firebase Console (console.firebase.google.com)
 * 2. Select your project: cvsift-3dff8
 * 3. Navigate to Firestore Database > Rules
 * 4. Copy the rules above and paste them into your existing firestore.rules file
 * 5. Make sure they are inside the existing "match /databases/{database}/documents" block
 * 6. Click "Publish" to deploy the new rules
 *
 * OR if using Firebase CLI:
 *
 * 1. Add the rules above to your local firestore.rules file
 * 2. Run: firebase deploy --only firestore:rules
 *
 * IMPORTANT NOTES:
 * - These rules ensure users can only access their own company data
 * - Reference data (sectorTargets, eapTargets) is read-only
 * - Only populate reference data manually through Firebase Console
 * - Test rules thoroughly before production deployment
 */
